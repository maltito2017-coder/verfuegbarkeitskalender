<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Gemeinsamer Kalender</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #kalender {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  table { border-collapse: collapse; }
  td, th { border: 1px solid #ccc; width: 40px; height: 40px; text-align: center; vertical-align: middle; cursor: pointer; }
  caption { font-weight: bold; margin-bottom: 10px; font-size: 1.2em; }
  .frei { background-color: white; }
  .feiertag { background-color: #ddd; }
  #legende span { margin-right: 15px; font-weight: bold; }
</style>
</head>
<body>

<h1>Gemeinsamer Kalender</h1>

<label>Teilnehmer: 
  <select id="teilnehmer">
    <option value="person1">Arne</option>
    <option value="person2">Malte</option>
    <option value="person3">Roman</option>
    <option value="person4">Sascha</option>
    <option value="person5">Seb</option>
  </select>
</label>

<!-- Legende neben Dropdown -->
<div id="legende">
  <span style="color:red;">■ Arne</span>
  <span style="color:blue;">■ Malte</span>
  <span style="color:green;">■ Roman</span>
  <span style="color:orange;">■ Sascha</span>
  <span style="color:purple;">■ Seb</span>
</div>

<div id="kalender"></div>

<script>
const API_URL = window.location.origin + '/api';
const colors = { person1:'red', person2:'blue', person3:'green', person4:'orange', person5:'purple' };

// Feiertage
const feiertage = {
  "NRW":["2026-01-01","2026-05-01","2026-10-03"],
  "RLP":["2026-01-01","2026-05-01","2026-10-03"],
  "HH":["2026-01-01","2026-05-01","2026-10-03"],
  "BE":["2026-01-01","2026-05-01","2026-10-03"]
};

const startMonth = 4; // April
const endMonth = 10;  // Oktober
const year = 2026;

let markedData = {};

async function loadData() {
  try {
    const res = await fetch(API_URL + '/calendar');
    markedData = await res.json();
  } catch(e) {
    console.error("Fehler beim Laden der Daten:", e);
    markedData = {};
  }
  renderKalender();
}

function renderKalender() {
  const container = document.getElementById('kalender');
  container.innerHTML = '';

  for(let m=startMonth; m<=endMonth; m++) {
    const firstDay = new Date(year, m-1, 1);
    const lastDay = new Date(year, m, 0);

    const table = document.createElement('table');

    const caption = document.createElement('caption');
    caption.textContent = firstDay.toLocaleString('de-DE',{month:'long', year:'numeric'});
    table.appendChild(caption);

    const header = document.createElement('tr');
    ["So","Mo","Di","Mi","Do","Fr","Sa"].forEach(d => {
      const th = document.createElement('th');
      th.textContent = d;
      header.appendChild(th);
    });
    table.appendChild(header);

    let tr = document.createElement('tr');
    let weekday = firstDay.getDay();
    for(let i=0;i<weekday;i++) tr.appendChild(document.createElement('td'));

    for(let day=1; day<=lastDay.getDate(); day++) {
      const td = document.createElement('td');
      const dateStr = `${year}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      td.textContent = day;
      td.className = 'frei';

      // Feiertag markieren
      for(let land in feiertage){
        if(feiertage[land].includes(dateStr)) td.className = 'feiertag';
      }

      // Markierungen aus Daten
      for(let person in markedData){
        if(markedData[person] && markedData[person].includes(dateStr)){
          td.style.backgroundColor = colors[person];
        }
      }

      td.onclick = () => {
        const person = document.getElementById('teilnehmer').value;
        if(!markedData[person]) markedData[person]=[];
        if(markedData[person].includes(dateStr)){
          markedData[person] = markedData[person].filter(d=>d!==dateStr);
          td.style.backgroundColor = 'white';
        } else {
          markedData[person].push(dateStr);
          td.style.backgroundColor = colors[person];
        }
        saveData();
      };

      tr.appendChild(td);
      weekday++;
      if(weekday % 7 === 0){
        table.appendChild(tr);
        tr = document.createElement('tr');
      }
    }
    table.appendChild(tr);
    container.appendChild(table);
  }
}

async function saveData(){
  try {
    await fetch(API_URL + '/calendar', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(markedData)
    });
  } catch(e) {
    console.error("Fehler beim Speichern:", e);
  }
}

window.onload = loadData;
</script>

</body>
</html>
